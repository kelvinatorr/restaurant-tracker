{{define "head"}}
<title>{{.Title}}</title>
<style>
    table, th, td {
        border: 1px solid black;
    }
</style>
{{end}}

{{define "yield"}}
<h1>Home Page</h1>
<form method="POST" action="/sign-out">
    <input type="submit" value="Sign Out" />
</form>
<br/>
<div>
    <div>
        <table>
            <thead>
              <tr>
                <th>
                  <a class="column-sort" href="/?sort[name]=asc">
                    Name
                  </a>
                </th>
                <th>
                  <a class="column-sort" href="/?sort[cuisine]=asc">
                    Cuisine
                  </a>
                </th>
                <th>
                  <a class="column-sort" href="/?sort[city]=asc">
                    City
                  </a>
                </th>
                <th>
                  <a class="column-sort" href="/?sort[state]=asc">
                    State
                  </a>
                </th>
                <th>
                    Note
                </th>
                <th>
                  <a class="column-sort" href="/?sort[last_visit]=asc">
                    Last Visit
                  </a>
                </th>
                <th>
                    User's Average Rating
                </th>
                <th>
                  <a class="column-sort" href="/?sort[avg_rating]=asc">
                    Average Rating
                  </a>
                </th>
              </tr>
            </thead>
            <tbody>
              {{range .Restaurants}}
              <tr>
                <td>{{.Name}}</td>
                <td>{{.Cuisine}}</td>
                <td>{{.CityState.Name}}</td>
                <td>{{.CityState.State}}</td>
                <td>{{.Note}}</td>
                <td>{{.LastVisitDatetime}}</td>
                <td>
                    {{range .AvgUserRatings}}
                    <p>
                      {{.FirstName}} {{.LastName}}: 
                      {{if .AvgRating}}
                      {{.AvgRating}}
                      {{else}}
                      null
                      {{end}}
                    </p>
                    {{end}}
                </td>
                <td>
                  {{if .AvgRating}}
                  {{.AvgRating}}
                  {{end}}
                </td>
              </tr>
              {{end}}
            </tbody>
          </table>
    </div>
</div>
{{end}}

{{define "script"}}
<script>
  (function() {
    setSortParams();

    function setSortParams() {
      // get the url parameters
      let urlParams = new URLSearchParams(window.location.search);

      let columnSorts = document.getElementsByClassName('column-sort');
      for (let i = 0; i < columnSorts.length; i++) {      
        let cs = columnSorts[i];
        let linkURL =  new URL(cs.href);
        for(const e of linkURL.searchParams.entries()) {
          let key = e[0];
          // skip query params on the a tag that are not related to sort
          if (key.substring(0, 4) != 'sort') {
            continue;
          }

          let urlValue = urlParams.get(key);
          // reverse the values
          switch (urlValue) {
            case null:
              break;
            case 'asc':
              linkURL.searchParams.set(key, 'desc');
              break;
            case 'desc':
              linkURL.searchParams.set(key, 'asc');
              break;
          }
        }
        // reset the url
        cs.href = linkURL;
      }    
    }
  })();
</script>
{{end}}